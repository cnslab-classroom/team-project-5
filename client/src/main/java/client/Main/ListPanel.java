package client.Main;

import javax.swing.*;
import java.awt.*;

import javax.swing.border.EmptyBorder;
import javax.swing.border.LineBorder;
import javax.swing.border.Border;

import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URI;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import client.Main.fetchData.FetchStudyList;
import client.Main.fetchData.FetchStudyListAdd;
import client.Main.model.GroupDetail;
import client.Main.model.ListItem;
import client.Main.model.MemberItem;
import client.Main.model.ReferenceLinkItem;
import client.Main.model.StudyItem;

public class ListPanel extends JPanel {
  private Border outerBorder = new LineBorder(Color.GRAY, 2, true);
  private Border innerBorder = new EmptyBorder(0, 10, 0, 10);

  private List<ListItem> studyItems = new ArrayList<>();
  private int selectGroupId = 1;
  GroupDetail groupDetail = FetchStudyList.fetchGroupDetail(selectGroupId);

  public ListPanel() {
    setLayout(new BorderLayout(10, 10)); // Ìå®ÎÑê Í∞Ñ Í∞ÑÍ≤©
    setBorder(new EmptyBorder(30, 30, 30, 30)); // Ï†ÑÏ≤¥ Ïó¨Î∞± ÏÑ§Ï†ï
    setBackground(Color.WHITE);

    // ÏÑúÎ≤ÑÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    fetchDataFromServer();

    // 1. ÏÉÅÎã® ÏòÅÏó≠ (ÌÖçÏä§Ìä∏ÏôÄ Í∑∏ÎûòÌîÑ)
    JPanel topPanel = studyListPanel();
    add(topPanel, BorderLayout.NORTH);

    // 2. Ï§ëÏïô ÏòÅÏó≠ (ÌÜµÍ≥Ñ Ï†ïÎ≥¥)
    JPanel middlePanel = studyPanel();
    add(middlePanel, BorderLayout.CENTER);

  }

  private void fetchDataFromServer() {
    // fetchStudyList ÌÅ¥ÎûòÏä§ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    studyItems = FetchStudyList.fetchStudyListData();
  }

  private JPanel studyListPanel() {
    JPanel studyListPanel = new JPanel(new BorderLayout());
    studyListPanel.setBackground(Color.WHITE);

    JPanel titlePanel = new JPanel(new BorderLayout());
    titlePanel.setLayout(new BoxLayout(titlePanel, BoxLayout.X_AXIS));
    titlePanel.setBackground(Color.WHITE);
    titlePanel.setBorder(new EmptyBorder(0, 10, 10, 10)); // ÎÇ¥Î∂Ä Ïó¨Î∞±

    JLabel titleLabel = new JLabel("Ïä§ÌÑ∞Îîî Î™©Î°ù");
    titleLabel.setFont(new Font("paperlogy", Font.PLAIN, 20));
    titleLabel.setHorizontalAlignment(SwingConstants.LEFT); // ÏôºÏ™Ω Ï†ïÎ†¨
    titlePanel.add(titleLabel, BorderLayout.WEST);

    JButton createButton = new JButton("+");
    createButton.setFont(new Font("paperlogy", Font.PLAIN, 20));
    createButton.setHorizontalAlignment(SwingConstants.CENTER); // Ïò§Î•∏Ï™Ω Ï†ïÎ†¨
    titlePanel.add(createButton, BorderLayout.EAST);

    // Ïä§ÌÑ∞Îîî Ï∂îÍ∞Ä Dialog
    createButton.addActionListener(e -> showStudyInputDialog());

    studyListPanel.add(titlePanel, BorderLayout.NORTH);

    JPanel listPanel = new JPanel();
    listPanel.setLayout(new BoxLayout(listPanel, BoxLayout.Y_AXIS));
    listPanel.setBackground(new Color(240, 240, 240));
    listPanel.setBorder(BorderFactory.createCompoundBorder(outerBorder, new EmptyBorder(10, 10, 0, 10)));

    // ÏÑúÎ≤ÑÏóêÏÑú Í∞ÄÏ†∏Ïò® Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú UI ÏÉùÏÑ±
    for (ListItem item : studyItems) {
      JPanel studyPanel = new JPanel(new BorderLayout());
      studyPanel.setBackground(new Color(240, 240, 240));
      studyPanel.setBorder(new EmptyBorder(0, 0, 10, 0)); // ÎÇ¥Î∂Ä Ïó¨Î∞±

      JLabel emojiLabel = new JLabel(item.getEmoji());
      emojiLabel.setFont(new Font("paperlogy", Font.PLAIN, 16));
      emojiLabel.setBorder(new EmptyBorder(0, 0, 0, 5)); // ÎÇ¥Î∂Ä Ïó¨Î∞±
      studyPanel.add(emojiLabel, BorderLayout.WEST);

      JLabel nameLabel = new JLabel(item.getName());
      nameLabel.setFont(new Font("paperlogy", Font.PLAIN, 16));
      studyPanel.add(nameLabel, BorderLayout.CENTER);

      listPanel.add(studyPanel);
    }
    studyListPanel.add(listPanel, BorderLayout.CENTER);

    return studyListPanel;
  }

  private JPanel studyPanel() {
    JPanel studyPanel = new JPanel(new BorderLayout());
    studyPanel.setBorder(new EmptyBorder(20, 0, 10, 0)); // ÎÇ¥Î∂Ä Ïó¨Î∞±
    studyPanel.setBackground(Color.WHITE);

    // ÏΩ§Î≥¥Î∞ïÏä§
    String[] names = new String[studyItems.size()];
    for (ListItem item : studyItems) {
      names[studyItems.indexOf(item)] = item.getName();
    }
    JComboBox<String> comboBox = new JComboBox<>(names);
    comboBox.setFont(new Font("paperlogy", Font.PLAIN, 20));

    // ÏΩ§Î≥¥Î∞ïÏä§ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
    comboBox.addActionListener(e -> {
      String selectedName = (String) comboBox.getSelectedItem();
      for (ListItem item : studyItems) {
        if (item.getName().equals(selectedName)) {
          selectGroupId = studyItems.indexOf(item) + 1;
          System.out.println("Selected Group ID: " + selectGroupId);
        }
      }
      groupDetail = FetchStudyList.fetchGroupDetail(selectGroupId);
    });

    // ÏÉÅÎã® Ìå®ÎÑêÏùÑ Î©îÏù∏ Ìå®ÎÑêÏóê Ï∂îÍ∞Ä
    studyPanel.add(comboBox, BorderLayout.NORTH);

    // Ï§ëÏïô Ìå®ÎÑê (ÌÖçÏä§Ìä∏ ÏòÅÏó≠)
    JPanel textPanel = new JPanel();
    textPanel.setLayout(new BoxLayout(textPanel, BoxLayout.Y_AXIS));
    textPanel.setBackground(new Color(240, 240, 240));
    textPanel.setBorder(BorderFactory.createCompoundBorder(outerBorder, innerBorder));

    // ÌÖçÏä§Ìä∏ ÏòÅÏó≠ - Î™©Ìëú
    JPanel goalPanel = new JPanel(new BorderLayout());
    goalPanel.setBackground(new Color(240, 240, 240));
    goalPanel.setBorder(new EmptyBorder(10, 0, 0, 10)); // ÎÇ¥Î∂Ä Ïó¨Î∞±

    JPanel goalLabelPanel = new JPanel();
    goalLabelPanel.setLayout(new FlowLayout(FlowLayout.LEFT, 0, 0));
    goalLabelPanel.setBackground(new Color(240, 240, 240));

    JLabel goalLabel = new JLabel("Î™©Ìëú üéØ");
    goalLabel.setForeground(Color.RED);
    goalLabel.setFont(new Font("paperlogy", Font.BOLD, 16));
    goalLabelPanel.add(goalLabel, BorderLayout.WEST);
    JButton goalButton = new JButton("+");
    goalButton.setFont(new Font("paperlogy", Font.PLAIN, 16));
    goalLabelPanel.add(goalButton, BorderLayout.EAST);

    goalButton.addActionListener(e -> showGoalInputDialog());

    goalPanel.add(goalLabelPanel, BorderLayout.NORTH);

    JPanel goalListPanel = new JPanel();
    goalListPanel.setLayout(new BoxLayout(goalListPanel, BoxLayout.Y_AXIS));
    goalListPanel.setBackground(Color.WHITE);
    goalListPanel.setBorder(new EmptyBorder(5, 10, 5, 10));

    for (StudyItem study : groupDetail.studies) {
      JPanel goalPanelList = new JPanel(new BorderLayout());
      goalPanelList.setBackground(Color.WHITE);

      JLabel dateLabel = new JLabel("üìÖ " + study.getDate() + "  ");
      dateLabel.setFont(new Font("paperlogy", Font.PLAIN, 16));
      goalPanelList.add(dateLabel, BorderLayout.WEST);

      JLabel textLabel = new JLabel(study.getText());
      textLabel.setFont(new Font("paperlogy", Font.PLAIN, 16));
      goalPanelList.add(textLabel, BorderLayout.CENTER);

      goalListPanel.add(goalPanelList);
    }

    goalPanel.add(goalListPanel, BorderLayout.CENTER);

    // ÌÖçÏä§Ìä∏ ÏòÅÏó≠ - Î©§Î≤Ñ
    JPanel memberPanel = new JPanel(new BorderLayout());
    memberPanel.setBackground(new Color(240, 240, 240));
    memberPanel.setBorder(new EmptyBorder(10, 0, 10, 0)); // ÎÇ¥Î∂Ä Ïó¨Î∞±

    JPanel memberLabelPanel = new JPanel();
    memberLabelPanel.setLayout(new FlowLayout(FlowLayout.LEFT, 0, 0));
    memberLabelPanel.setBackground(new Color(240, 240, 240));

    JLabel memberLabel = new JLabel("Î©§Î≤Ñ üë•");
    memberLabel.setForeground(new Color(40, 167, 69));
    memberLabel.setFont(new Font("paperlogy", Font.BOLD, 16));
    memberLabelPanel.add(memberLabel, BorderLayout.WEST);
    JButton memberButton = new JButton("+");
    memberButton.setFont(new Font("paperlogy", Font.PLAIN, 16));
    memberLabelPanel.add(memberButton, BorderLayout.EAST);

    memberButton.addActionListener(e -> showMemberInputDialog());

    memberPanel.add(memberLabelPanel, BorderLayout.NORTH);

    JPanel memberListPanel = new JPanel();
    memberListPanel.setLayout(new BoxLayout(memberListPanel, BoxLayout.Y_AXIS));
    memberListPanel.setBackground(Color.WHITE);
    memberListPanel.setBorder(outerBorder);
    memberListPanel.setBorder(new EmptyBorder(5, 10, 5, 10));

    for (MemberItem member : groupDetail.members) {
      JPanel memberPanelList = new JPanel(new BorderLayout());
      memberPanelList.setBackground(Color.WHITE);

      JLabel emojiLabel = new JLabel(member.getEmoji() + " ");
      emojiLabel.setFont(new Font("paperlogy", Font.PLAIN, 16));
      memberPanelList.add(emojiLabel, BorderLayout.WEST);

      JLabel nameLabel = new JLabel(member.getName());
      nameLabel.setFont(new Font("paperlogy", Font.PLAIN, 16));
      memberPanelList.add(nameLabel, BorderLayout.CENTER);

      memberListPanel.add(memberPanelList);
    }

    memberPanel.add(memberListPanel, BorderLayout.CENTER);

    // ÌÖçÏä§Ìä∏ ÏòÅÏó≠ - Î†àÌçºÎü∞Ïä§
    JPanel referencePanel = new JPanel(new BorderLayout());
    referencePanel.setBackground(new Color(240, 240, 240));
    referencePanel.setBorder(new EmptyBorder(10, 0, 10, 0)); // ÎÇ¥Î∂Ä Ïó¨Î∞±

    JPanel referenceLabelPanel = new JPanel();
    referenceLabelPanel.setLayout(new FlowLayout(FlowLayout.LEFT, 0, 0));
    referenceLabelPanel.setBackground(new Color(240, 240, 240));

    JLabel referenceLabel = new JLabel("Î†àÌçºÎü∞Ïä§ üåê");
    referenceLabel.setForeground(Color.BLUE);
    referenceLabel.setFont(new Font("paperlogy", Font.BOLD, 16));
    referenceLabelPanel.add(referenceLabel, BorderLayout.WEST);
    JButton referenceButton = new JButton("+");
    referenceButton.setFont(new Font("paperlogy", Font.PLAIN, 16));
    referenceLabelPanel.add(referenceButton, BorderLayout.EAST);

    referenceButton.addActionListener(e -> showReferenceInputDialog());

    referencePanel.add(referenceLabelPanel, BorderLayout.NORTH);

    JPanel referenceListPanel = new JPanel();
    referenceListPanel.setLayout(new BoxLayout(referenceListPanel, BoxLayout.Y_AXIS));
    referenceListPanel.setBackground(Color.WHITE);
    referenceListPanel.setBorder(outerBorder);
    referenceListPanel.setBorder(new EmptyBorder(5, 10, 5, 10));

    for (ReferenceLinkItem reference : groupDetail.referenceLinks) {
      JPanel referencePanelList = new JPanel(new FlowLayout(FlowLayout.LEFT));
      referencePanelList.setBackground(Color.WHITE);

      String htmlLink = String.format("<html><div style='width:300px;'>üîó <a href=''>%s</a></div></html>",
          reference.getName());

      JLabel linkLabel = new JLabel(htmlLink);
      linkLabel.setCursor(new Cursor(Cursor.HAND_CURSOR));
      linkLabel.setFont(new Font("paperlogy", Font.PLAIN, 16));

      // ÎßàÏö∞Ïä§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Î°ú ÎßÅÌÅ¨ Ïó¥Í∏∞
      final String url = reference.getUrl();
      linkLabel.addMouseListener(new MouseAdapter() {
        @Override
        public void mouseClicked(MouseEvent e) {
          openWebpage(url); // URL Ïó¥Í∏∞
        }
      });

      referencePanelList.add(linkLabel);
      referenceListPanel.add(referencePanelList);
    }

    referencePanel.add(referenceListPanel, BorderLayout.CENTER);

    textPanel.add(goalPanel);
    textPanel.add(memberPanel);
    textPanel.add(referencePanel);

    // Ï§ëÏïô ÌÖçÏä§Ìä∏ Ìå®ÎÑêÏùÑ Î©îÏù∏ Ìå®ÎÑêÏóê Ï∂îÍ∞Ä
    studyPanel.add(textPanel, BorderLayout.CENTER);

    return studyPanel;
  }

  // ÎßÅÌÅ¨ Ïó¥Í∏∞ Î©îÏÑúÎìú
  private void openWebpage(String url) {
    try {
      Desktop desktop = Desktop.getDesktop();
      desktop.browse(new URI(url));
    } catch (Exception e) {
      e.printStackTrace();
      JOptionPane.showMessageDialog(this, "Failed to open the link: " + url);
    }
  }

  private void refreshData() {
    // ÏÑúÎ≤ÑÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    studyItems = FetchStudyList.fetchStudyListData();
    groupDetail = FetchStudyList.fetchGroupDetail(selectGroupId);

    // ÌôîÎ©¥ Í∞±Ïã†
    removeAll();
    JPanel topPanel = studyListPanel();
    JPanel middlePanel = studyPanel();

    add(topPanel, BorderLayout.NORTH);
    add(middlePanel, BorderLayout.CENTER);

    revalidate();
    repaint();
  }

  // Ïä§ÌÑ∞Îîî Í∑∏Î£π Ï∂îÍ∞Ä Dialog
  private void showStudyInputDialog() {
    JTextField study_group_name = new JTextField();
    JTextField study_emoji = new JTextField();

    Object[] inputFields = {
        "Ïù¥Î¶Ñ:", study_group_name,
        "Ïù¥Î™®ÏßÄ:", study_emoji,
    };

    int option = JOptionPane.showConfirmDialog(
        this,
        inputFields,
        "Ïä§ÌÑ∞Îîî Í∑∏Î£π Ï∂îÍ∞Ä",
        JOptionPane.OK_CANCEL_OPTION,
        JOptionPane.PLAIN_MESSAGE);

    if (option == JOptionPane.OK_OPTION) {
      String name = study_group_name.getText().trim();
      String emoji = study_emoji.getText().trim();

      if (name.isEmpty() || emoji.isEmpty()) {
        JOptionPane.showMessageDialog(this, "Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", "ÏûÖÎ†• Ïò§Î•ò", JOptionPane.ERROR_MESSAGE);
      } else {
        // FetchStudyListGoal ÌÅ¥ÎûòÏä§Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÏÑúÎ≤ÑÎ°ú POST ÏöîÏ≤≠ Ï†ÑÏÜ°
        FetchStudyListAdd.sendPostList(name, emoji);
        refreshData();
      }
    }
  }

  // Î™©Ìëú Ï∂îÍ∞Ä Dialog
  private void showGoalInputDialog() {
    JTextField nameField = new JTextField();
    JTextField endDateField = new JTextField();
    JTextField emojiField = new JTextField();

    Object[] inputFields = {
        "Ïù¥Î¶Ñ:", nameField,
        "Ï¢ÖÎ£åÏùº (yyyy-MM-dd):", endDateField,
        "Ïù¥Î™®ÏßÄ:", emojiField
    };

    int option = JOptionPane.showConfirmDialog(
        this,
        inputFields,
        "Î™©Ìëú Ï∂îÍ∞Ä",
        JOptionPane.OK_CANCEL_OPTION,
        JOptionPane.PLAIN_MESSAGE);

    if (option == JOptionPane.OK_OPTION) {
      String name = nameField.getText().trim();
      String endDate = endDateField.getText().trim();
      String emoji = emojiField.getText().trim();

      if (name.isEmpty() || endDate.isEmpty() || emoji.isEmpty()) {
        JOptionPane.showMessageDialog(this, "Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", "ÏûÖÎ†• Ïò§Î•ò", JOptionPane.ERROR_MESSAGE);
      } else {
        // FetchStudyListGoal ÌÅ¥ÎûòÏä§Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÏÑúÎ≤ÑÎ°ú POST ÏöîÏ≤≠ Ï†ÑÏÜ°
        FetchStudyListAdd.sendPostGoal(name, endDate, emoji, selectGroupId);
        refreshData();
      }
    }
  }

  // Î©§Î≤Ñ Ï∂îÍ∞Ä Dialog
  private void showMemberInputDialog() {
    String input = JOptionPane.showInputDialog(this, "Ï∂îÍ∞ÄÌï† Î©§Î≤ÑÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:", "Î©§Î≤Ñ Ï∂îÍ∞Ä", JOptionPane.PLAIN_MESSAGE);

    if (input != null && !input.trim().isEmpty()) {
      // ÏÑúÎ≤ÑÎ°ú POST ÏöîÏ≤≠ Ï†ÑÏÜ°
      FetchStudyListAdd.sendPostMember(input, selectGroupId);
      refreshData();
    } else {
      JOptionPane.showMessageDialog(this, "ÏûÖÎ†•Îêú Í∞íÏù¥ ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.", "Ïò§Î•ò", JOptionPane.ERROR_MESSAGE);
    }
  }

  // Î†àÌçºÎü∞Ïä§ Ï∂îÍ∞Ä Dialog
  private void showReferenceInputDialog() {
    JTextField reference_name = new JTextField();
    JTextField reference_url = new JTextField();

    Object[] inputFields = {
        "Ïù¥Î¶Ñ:", reference_name,
        "url:", reference_url,
    };

    int option = JOptionPane.showConfirmDialog(
        this,
        inputFields,
        "Î†àÌçºÎü∞Ïä§ Ï∂îÍ∞Ä",
        JOptionPane.OK_CANCEL_OPTION,
        JOptionPane.PLAIN_MESSAGE);

    if (option == JOptionPane.OK_OPTION) {
      String name = reference_name.getText().trim();
      String url = reference_url.getText().trim();

      if (name.isEmpty() || url.isEmpty()) {
        JOptionPane.showMessageDialog(this, "Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", "ÏûÖÎ†• Ïò§Î•ò", JOptionPane.ERROR_MESSAGE);
      } else {
        // FetchStudyListGoal ÌÅ¥ÎûòÏä§Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÏÑúÎ≤ÑÎ°ú POST ÏöîÏ≤≠ Ï†ÑÏÜ°
        FetchStudyListAdd.sendPostReference(name, url, selectGroupId);
        refreshData();
      }
    }
  }

}